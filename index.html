<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“š ì¶œíŒ ì—…ë¬´ ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap');
    * { font-family: 'Noto Sans KR', sans-serif; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 16px; }
    .modal-content { background: white; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
    .input-field { width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
    .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: #f1f5f9; color: #475569; }
    .btn-secondary:hover { background: #e2e8f0; }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-danger:hover { background: #fecaca; }
    .stage-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; z-index: 100; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .kanban-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; }
    .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
  <div id="app">
    <!-- ì„¤ì • ëª¨ë‹¬ (Google Sheets) -->
    <div id="setupModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-xl">
        <h2 class="text-xl font-bold text-slate-800 mb-4">ğŸ”— Google Sheets ì—°ê²°</h2>
        <p class="text-slate-600 text-sm mb-4">íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ ë™ê¸°í™”ë¥¼ ìœ„í•œ Apps Script ì›¹ ì•± URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì„ íƒì‚¬í•­)</p>
        <input 
          type="text" 
          id="apiUrlInput"
          placeholder="https://script.google.com/macros/s/..."
          class="w-full px-4 py-3 bg-slate-50 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm mb-4"
        >
        <div class="flex gap-3">
          <button onclick="skipSetup()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-medium hover:bg-slate-200 transition-colors">
            ë‚˜ì¤‘ì—
          </button>
          <button onclick="saveApiUrl()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition-colors">
            ì—°ê²°í•˜ê¸°
          </button>
        </div>
        <p class="text-xs text-slate-400 mt-3 text-center">ì—°ê²°í•˜ì§€ ì•Šì•„ë„ ë¡œì»¬ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- ë¡œë”© -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-40">
      <div class="text-center">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-slate-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toastContainer"></div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div id="mainContent" class="hidden">
      <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
      <nav class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto px-4">
          <div class="flex items-center justify-between h-16">
            <h1 class="text-xl font-bold text-slate-800">ğŸ“š ì¶œíŒ ì—…ë¬´ ê´€ë¦¬</h1>
            
            <!-- ë©”ì¸ íƒ­ -->
            <div class="flex bg-slate-100 rounded-xl p-1">
              <button onclick="switchTab('todo')" id="todoTab" class="tab-btn flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-medium transition-colors bg-white text-slate-800 shadow-sm">
                ğŸ“‹ íˆ¬ë‘
              </button>
              <button onclick="switchTab('rights')" id="rightsTab" class="tab-btn flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-medium transition-colors text-slate-600 hover:text-slate-800">
                ğŸŒ ì™¸ì„œ ê´€ë¦¬
              </button>
            </div>

            <button onclick="showSetup()" class="text-slate-400 hover:text-slate-600 text-sm">
              âš™ï¸ ì„¤ì •
            </button>
          </div>
        </div>
      </nav>

      <!-- íˆ¬ë‘ ì„¹ì…˜ -->
      <div id="todoSection" class="p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
          <!-- íˆ¬ë‘ í—¤ë” -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 mb-1">ì˜¤ëŠ˜ì˜ í•  ì¼</h2>
              <p class="text-slate-500 text-sm">í•˜ë‚˜ì”© í•´ê²°í•´ ë‚˜ê°€ìš”</p>
            </div>
            
            <!-- ë·° í† ê¸€ -->
            <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-200">
              <button onclick="setTodoView('list')" id="todoListBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-slate-800 text-white">
                ëª©ë¡
              </button>
              <button onclick="setTodoView('calendar')" id="todoCalendarBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors text-slate-600 hover:bg-slate-100">
                ìº˜ë¦°ë”
              </button>
            </div>
          </div>

          <!-- í†µê³„ -->
          <div class="grid grid-cols-3 gap-3 md:gap-4 mb-6">
            <div class="bg-white rounded-xl p-3 md:p-4 shadow-sm border border-slate-100">
              <div id="statRemaining" class="text-xl md:text-2xl font-bold text-slate-800">0</div>
              <div class="text-xs md:text-sm text-slate-500">ë‚¨ì€ í•  ì¼</div>
            </div>
            <div class="bg-white rounded-xl p-3 md:p-4 shadow-sm border border-slate-100">
              <div id="statCompleted" class="text-xl md:text-2xl font-bold text-green-600">0</div>
              <div class="text-xs md:text-sm text-slate-500">ì™„ë£Œ</div>
            </div>
            <div class="bg-white rounded-xl p-3 md:p-4 shadow-sm border border-slate-100">
              <div id="statOverdue" class="text-xl md:text-2xl font-bold text-red-500">0</div>
              <div class="text-xs md:text-sm text-slate-500">ê¸°í•œ ì´ˆê³¼</div>
            </div>
          </div>

          <!-- íˆ¬ë‘ ì¶”ê°€ í¼ -->
          <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm border border-slate-100 mb-6">
            <div class="flex gap-2 md:gap-3 mb-4">
              <input type="text" id="newTodoInput" placeholder="ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" class="input-field flex-1" onkeypress="if(event.key === 'Enter') addTodo()">
              <button onclick="addTodo()" class="btn btn-primary flex items-center gap-2">
                <span>+</span> <span class="hidden md:inline">ì¶”ê°€</span>
              </button>
            </div>
            
            <div class="flex flex-wrap gap-2 md:gap-3">
              <select id="newCategory" class="input-field w-auto">
                <option value="manuscript">ì›ê³  ê²€í† </option>
                <option value="planning">ê¸°íšì•ˆ</option>
                <option value="foreign">ì™¸ì„œ ì—…ë¬´</option>
                <option value="email">ë©”ì¼</option>
                <option value="other" selected>ê¸°íƒ€</option>
              </select>
              
              <select id="newPriority" class="input-field w-auto">
                <option value="high">ê¸´ê¸‰</option>
                <option value="medium" selected>ë³´í†µ</option>
                <option value="low">ë‚®ìŒ</option>
              </select>
              
              <input type="date" id="newDueDate" class="input-field w-auto">
            </div>
          </div>

          <!-- ë¦¬ìŠ¤íŠ¸ ë·° -->
          <div id="todoListView">
            <div class="flex flex-wrap gap-2 mb-4 overflow-x-auto pb-2" id="filterButtons"></div>
            <div class="flex items-center gap-2 mb-4">
              <input type="checkbox" id="showCompleted" checked onchange="renderTodos()" class="w-4 h-4 rounded">
              <label for="showCompleted" class="text-sm text-slate-500">ì™„ë£Œëœ í•­ëª© í‘œì‹œ</label>
            </div>
            <div id="todoList" class="space-y-3"></div>
          </div>

          <!-- ìº˜ë¦°ë” ë·° -->
          <div id="todoCalendarView" class="hidden">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
              <div class="flex items-center justify-between p-4 border-b border-slate-100">
                <button onclick="prevMonth()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">â—€</button>
                <div class="flex items-center gap-3">
                  <h3 id="calendarTitle" class="text-lg font-semibold text-slate-800"></h3>
                  <button onclick="goToToday()" class="px-3 py-1 text-xs font-medium text-blue-600 bg-blue-50 rounded-full hover:bg-blue-100">ì˜¤ëŠ˜</button>
                </div>
                <button onclick="nextMonth()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">â–¶</button>
              </div>
              <div class="grid grid-cols-7 border-b border-slate-100">
                <div class="p-2 text-center text-sm font-medium text-red-500">ì¼</div>
                <div class="p-2 text-center text-sm font-medium text-slate-500">ì›”</div>
                <div class="p-2 text-center text-sm font-medium text-slate-500">í™”</div>
                <div class="p-2 text-center text-sm font-medium text-slate-500">ìˆ˜</div>
                <div class="p-2 text-center text-sm font-medium text-slate-500">ëª©</div>
                <div class="p-2 text-center text-sm font-medium text-slate-500">ê¸ˆ</div>
                <div class="p-2 text-center text-sm font-medium text-blue-500">í† </div>
              </div>
              <div id="calendarGrid" class="grid grid-cols-7"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì™¸ì„œ ê´€ë¦¬ ì„¹ì…˜ -->
      <div id="rightsSection" class="hidden p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
          <!-- ì™¸ì„œ í—¤ë” -->
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 mb-1">ì™¸ì„œ ìˆ˜ì… ê´€ë¦¬</h2>
              <p class="text-slate-500 text-sm">í•´ì™¸ ì €ì‘ê¶Œ ê³„ì•½ í˜„í™©</p>
            </div>
            
            <div class="flex items-center gap-3">
              <button onclick="showAlertsModal()" id="alertsBtn" class="relative btn btn-secondary">
                ğŸ”” ì•Œë¦¼ <span id="alertsBadge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center"></span>
              </button>
              <button onclick="exportToExcel()" class="btn btn-secondary">ğŸ“Š ì—‘ì…€</button>
              <button onclick="showAddBookModal()" class="btn btn-primary">+ ìƒˆ ë„ì„œ</button>
            </div>
          </div>

          <!-- í•„í„° & ê²€ìƒ‰ -->
          <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 mb-6">
            <div class="flex flex-wrap gap-3">
              <input type="text" id="bookSearch" placeholder="ë„ì„œëª…, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰" class="input-field flex-1 min-w-48" oninput="renderBooks()">
              <select id="stageFilter" class="input-field w-auto" onchange="renderBooks()">
                <option value="all">ì „ì²´ ë‹¨ê³„</option>
              </select>
              <select id="countryFilter" class="input-field w-auto" onchange="renderBooks()">
                <option value="all">ì „ì²´ êµ­ê°€</option>
              </select>
              <div class="flex bg-slate-100 rounded-lg p-1">
                <button onclick="setRightsView('table')" id="rightsTableBtn" class="px-4 py-2 rounded-md text-sm font-medium bg-white shadow-sm">í…Œì´ë¸”</button>
                <button onclick="setRightsView('kanban')" id="rightsKanbanBtn" class="px-4 py-2 rounded-md text-sm font-medium text-slate-600">ì¹¸ë°˜</button>
              </div>
            </div>
          </div>

          <!-- í…Œì´ë¸” ë·° -->
          <div id="rightsTableView" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="text-left p-4 font-semibold text-slate-600 text-sm">ë„ì„œëª…</th>
                    <th class="text-left p-4 font-semibold text-slate-600 text-sm">ì €ì</th>
                    <th class="text-left p-4 font-semibold text-slate-600 text-sm">êµ­ê°€</th>
                    <th class="text-left p-4 font-semibold text-slate-600 text-sm">ì¶œíŒì‚¬</th>
                    <th class="text-left p-4 font-semibold text-slate-600 text-sm">ì§„í–‰ ë‹¨ê³„</th>
                    <th class="text-left p-4 font-semibold text-slate-600 text-sm">ì„ ì¸ì„¸</th>
                    <th class="text-left p-4 font-semibold text-slate-600 text-sm">ê³„ì•½ ë§Œë£Œ</th>
                  </tr>
                </thead>
                <tbody id="booksTableBody"></tbody>
              </table>
            </div>
          </div>

          <!-- ì¹¸ë°˜ ë·° -->
          <div id="rightsKanbanView" class="hidden">
            <div id="kanbanBoard" class="flex gap-4 overflow-x-auto pb-4"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë„ì„œ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="editBookModal" class="hidden modal-overlay" onclick="closeModal('editBookModal')">
      <div class="modal-content w-full max-w-2xl p-6" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-slate-800">ğŸ“– ë„ì„œ ìƒì„¸</h3>
          <button onclick="closeModal('editBookModal')" class="text-2xl text-slate-400 hover:text-slate-600">Ã—</button>
        </div>
        <div id="editBookContent"></div>
      </div>
    </div>

    <!-- ë„ì„œ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addBookModal" class="hidden modal-overlay" onclick="closeModal('addBookModal')">
      <div class="modal-content w-full max-w-lg p-6" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-slate-800">ğŸ“š ìƒˆ ë„ì„œ ë“±ë¡</h3>
          <button onclick="closeModal('addBookModal')" class="text-2xl text-slate-400 hover:text-slate-600">Ã—</button>
        </div>
        <div id="addBookContent"></div>
      </div>
    </div>

    <!-- ì•Œë¦¼ ëª¨ë‹¬ -->
    <div id="alertsModal" class="hidden modal-overlay" onclick="closeModal('alertsModal')">
      <div class="modal-content w-full max-w-md p-6" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-slate-800">ğŸ”” ê³„ì•½ ë§Œë£Œ ì•Œë¦¼</h3>
          <button onclick="closeModal('alertsModal')" class="text-2xl text-slate-400 hover:text-slate-600">Ã—</button>
        </div>
        <div id="alertsContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ==================== ìƒìˆ˜ ====================
    const STAGES = [
      { id: 1, name: 'ì›ê³  ê²€í† ', icon: 'ğŸ“–' },
      { id: 2, name: 'ì˜¤í¼ ì ‘ìˆ˜', icon: 'ğŸ“¨' },
      { id: 3, name: 'ì˜¤í¼ ìŠ¹ì¸', icon: 'âœ…' },
      { id: 4, name: 'ê³„ì•½ì„œ ì´ˆì•ˆ', icon: 'ğŸ“' },
      { id: 5, name: 'ê³„ì•½ì„œ ì„œëª…', icon: 'âœï¸' },
      { id: 6, name: 'ê³„ì•½ ì™„ë£Œ', icon: 'ğŸ¤' },
      { id: 7, name: 'ìë£Œ ê³µìœ ', icon: 'ğŸ“¤' },
      { id: 8, name: 'ë„ì„œ ë°œì†¡', icon: 'ğŸ“¦' },
      { id: 9, name: 'ì„ ì¸ì„¸ ì…ê¸ˆ', icon: 'ğŸ’°' },
      { id: 10, name: 'í‘œì§€/íŒê¶Œ ìŠ¹ì¸', icon: 'ğŸ¨' },
      { id: 11, name: 'ì¶œê°„ í™•ì¸', icon: 'ğŸ‰' },
      { id: 12, name: 'ì¶”ê°€ ì¸ì„¸', icon: 'ğŸ’µ' },
      { id: 13, name: 'í•´ì™¸íŒ ì…ìˆ˜', icon: 'ğŸ“š' },
      { id: 14, name: 'ê³„ì•½ ë§Œë£Œ', icon: 'ğŸ“‹' },
    ];

    const COUNTRIES = ['ì¼ë³¸', 'ì¤‘êµ­', 'ëŒ€ë§Œ', 'íƒœêµ­', 'ë² íŠ¸ë‚¨', 'ì¸ë„ë„¤ì‹œì•„', 'ë¯¸êµ­', 'ì˜êµ­', 'í”„ë‘ìŠ¤', 'ë…ì¼', 'ìŠ¤í˜ì¸', 'ì´íƒˆë¦¬ì•„', 'ëŸ¬ì‹œì•„', 'í´ë€ë“œ', 'í„°í‚¤'];
    const COUNTRY_FLAGS = { 'ì¼ë³¸': 'ğŸ‡¯ğŸ‡µ', 'ì¤‘êµ­': 'ğŸ‡¨ğŸ‡³', 'ëŒ€ë§Œ': 'ğŸ‡¹ğŸ‡¼', 'íƒœêµ­': 'ğŸ‡¹ğŸ‡­', 'ë² íŠ¸ë‚¨': 'ğŸ‡»ğŸ‡³', 'ì¸ë„ë„¤ì‹œì•„': 'ğŸ‡®ğŸ‡©', 'ë¯¸êµ­': 'ğŸ‡ºğŸ‡¸', 'ì˜êµ­': 'ğŸ‡¬ğŸ‡§', 'í”„ë‘ìŠ¤': 'ğŸ‡«ğŸ‡·', 'ë…ì¼': 'ğŸ‡©ğŸ‡ª', 'ìŠ¤í˜ì¸': 'ğŸ‡ªğŸ‡¸', 'ì´íƒˆë¦¬ì•„': 'ğŸ‡®ğŸ‡¹', 'ëŸ¬ì‹œì•„': 'ğŸ‡·ğŸ‡º', 'í´ë€ë“œ': 'ğŸ‡µğŸ‡±', 'í„°í‚¤': 'ğŸ‡¹ğŸ‡·' };

    const TODO_CATEGORIES = {
      manuscript: { name: 'ì›ê³  ê²€í† ', color: 'bg-blue-500', light: 'bg-blue-100 text-blue-700' },
      planning: { name: 'ê¸°íšì•ˆ', color: 'bg-purple-500', light: 'bg-purple-100 text-purple-700' },
      foreign: { name: 'ì™¸ì„œ ì—…ë¬´', color: 'bg-green-500', light: 'bg-green-100 text-green-700' },
      email: { name: 'ë©”ì¼', color: 'bg-yellow-500', light: 'bg-yellow-100 text-yellow-700' },
      other: { name: 'ê¸°íƒ€', color: 'bg-gray-500', light: 'bg-gray-100 text-gray-700' }
    };

    const PRIORITIES = {
      high: { name: 'ê¸´ê¸‰', color: 'text-red-500', bg: 'bg-red-50' },
      medium: { name: 'ë³´í†µ', color: 'text-orange-500', bg: 'bg-orange-50' },
      low: { name: 'ë‚®ìŒ', color: 'text-gray-500', bg: 'bg-gray-50' }
    };

    const sampleBooks = [
      { id: 1, title: 'ë‹¬ë¹› ì•„ë˜ ì •ì›', author: 'ê¹€ì„œì—°', country: 'ì¼ë³¸', publisher: 'Kadokawa', stage: 11, contractDate: '2024-03-15', expiryDate: '2027-03-14', advance: 5000, currency: 'USD', notes: 'í‘œì§€ ë””ìì¸ ì»¨íŒ ì™„ë£Œ', royalties: [] },
      { id: 2, title: 'ì½”ë“œì˜ ë¯¸í•™', author: 'ë°•ì¤€í˜¸', country: 'ëŒ€ë§Œ', publisher: 'Crown Publishing', stage: 6, contractDate: '2024-08-01', expiryDate: '2027-07-31', advance: 3000, currency: 'USD', notes: 'ê³„ì•½ê¸ˆ í˜‘ìƒ ì™„ë£Œ', royalties: [] },
      { id: 3, title: 'ì‚¬ë¼ì§„ ì‹œê°„ë“¤', author: 'ì´í•˜ëŠ˜', country: 'ì¤‘êµ­', publisher: 'CITIC Press', stage: 9, contractDate: '2024-05-20', expiryDate: '2027-05-19', advance: 8000, currency: 'USD', notes: 'ì„ ì¸ì„¸ ì…ê¸ˆ ëŒ€ê¸° ì¤‘', royalties: [] },
    ];

    // ==================== ìƒíƒœ ====================
    let todos = [];
    let books = [];
    let currentTab = 'todo';
    let todoView = 'list';
    let rightsView = 'table';
    let currentFilter = 'all';
    let currentMonth = new Date();
    let selectedBook = null;
    let API_URL = '';

    // ==================== ì´ˆê¸°í™” ====================
    document.addEventListener('DOMContentLoaded', async () => {
      API_URL = localStorage.getItem('todoApiUrl') || '';
      
      // í•„í„° ë²„íŠ¼ ìƒì„±
      initFilters();
      
      // ë°ì´í„° ë¡œë“œ
      await loadAllData();
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('loadingScreen').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      renderTodos();
      renderBooks();
      renderCalendar();
      updateAlertsBadge();
    });

    function initFilters() {
      // íˆ¬ë‘ í•„í„°
      const filterContainer = document.getElementById('filterButtons');
      filterContainer.innerHTML = `
        <button onclick="setFilter('all')" data-filter="all" class="filter-btn px-3 py-2 rounded-full text-sm font-medium bg-slate-800 text-white">ì „ì²´</button>
        ${Object.entries(TODO_CATEGORIES).map(([id, cat]) => `
          <button onclick="setFilter('${id}')" data-filter="${id}" class="filter-btn px-3 py-2 rounded-full text-sm font-medium bg-white text-slate-600 hover:bg-slate-100">${cat.name}</button>
        `).join('')}
      `;

      // ì™¸ì„œ ë‹¨ê³„ í•„í„°
      const stageFilter = document.getElementById('stageFilter');
      stageFilter.innerHTML = '<option value="all">ì „ì²´ ë‹¨ê³„</option>' + 
        STAGES.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');

      // êµ­ê°€ í•„í„°
      const countryFilter = document.getElementById('countryFilter');
      countryFilter.innerHTML = '<option value="all">ì „ì²´ êµ­ê°€</option>' + 
        COUNTRIES.map(c => `<option value="${c}">${COUNTRY_FLAGS[c]} ${c}</option>`).join('');
    }

    async function loadAllData() {
      // íˆ¬ë‘ ë¡œë“œ
      try {
        if (API_URL) {
          const response = await fetch(`${API_URL}?action=get&t=${Date.now()}`);
          const data = await response.json();
          todos = data.todos || [];
        } else {
          const stored = localStorage.getItem('todos');
          todos = stored ? JSON.parse(stored) : [];
        }
      } catch (e) {
        const stored = localStorage.getItem('todos');
        todos = stored ? JSON.parse(stored) : [];
      }

      // ë„ì„œ ë¡œë“œ
      try {
        const stored = localStorage.getItem('rights-books');
        books = stored ? JSON.parse(stored) : sampleBooks;
      } catch (e) {
        books = sampleBooks;
      }
    }

    // ==================== íƒ­ ì „í™˜ ====================
    function switchTab(tab) {
      currentTab = tab;
      
      document.getElementById('todoTab').className = `tab-btn flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-medium transition-colors ${tab === 'todo' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-600 hover:text-slate-800'}`;
      document.getElementById('rightsTab').className = `tab-btn flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-medium transition-colors ${tab === 'rights' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-600 hover:text-slate-800'}`;
      
      document.getElementById('todoSection').classList.toggle('hidden', tab !== 'todo');
      document.getElementById('rightsSection').classList.toggle('hidden', tab !== 'rights');
    }

    // ==================== ì„¤ì • ====================
    function showSetup() {
      document.getElementById('apiUrlInput').value = API_URL;
      document.getElementById('setupModal').classList.remove('hidden');
    }

    function skipSetup() {
      document.getElementById('setupModal').classList.add('hidden');
    }

    async function saveApiUrl() {
      const url = document.getElementById('apiUrlInput').value.trim();
      API_URL = url;
      localStorage.setItem('todoApiUrl', url);
      document.getElementById('setupModal').classList.add('hidden');
      
      if (url) {
        await loadAllData();
        renderTodos();
      }
      showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ==================== í† ìŠ¤íŠ¸ ====================
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ==================== íˆ¬ë‘ ê¸°ëŠ¥ ====================
    function setTodoView(view) {
      todoView = view;
      document.getElementById('todoListBtn').className = `flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${view === 'list' ? 'bg-slate-800 text-white' : 'text-slate-600 hover:bg-slate-100'}`;
      document.getElementById('todoCalendarBtn').className = `flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${view === 'calendar' ? 'bg-slate-800 text-white' : 'text-slate-600 hover:bg-slate-100'}`;
      document.getElementById('todoListView').classList.toggle('hidden', view !== 'list');
      document.getElementById('todoCalendarView').classList.toggle('hidden', view !== 'calendar');
      if (view === 'calendar') renderCalendar();
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.className = `filter-btn px-3 py-2 rounded-full text-sm font-medium ${btn.dataset.filter === filter ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 hover:bg-slate-100'}`;
      });
      renderTodos();
    }

    async function addTodo() {
      const text = document.getElementById('newTodoInput').value.trim();
      if (!text) return;

      const todo = {
        id: Date.now().toString(),
        text,
        category: document.getElementById('newCategory').value,
        priority: document.getElementById('newPriority').value,
        dueDate: document.getElementById('newDueDate').value,
        completed: false,
        createdAt: new Date().toISOString()
      };

      todos.unshift(todo);
      document.getElementById('newTodoInput').value = '';
      document.getElementById('newDueDate').value = '';
      
      await saveTodos();
      renderTodos();
      renderCalendar();
    }

    async function toggleTodo(id) {
      const todo = todos.find(t => t.id === id);
      if (todo) {
        todo.completed = !todo.completed;
        await saveTodos();
        renderTodos();
        renderCalendar();
      }
    }

    async function deleteTodo(id) {
      todos = todos.filter(t => t.id !== id);
      await saveTodos();
      renderTodos();
      renderCalendar();
    }

    async function saveTodos() {
      localStorage.setItem('todos', JSON.stringify(todos));
      if (API_URL) {
        try {
          // ê°„ë‹¨í•œ ë™ê¸°í™” (ì „ì²´ ì €ì¥)
          await fetch(`${API_URL}?action=save&todos=${encodeURIComponent(JSON.stringify(todos))}&t=${Date.now()}`);
        } catch (e) {
          console.log('Sync failed, saved locally');
        }
      }
    }

    function isOverdue(dueDate, completed) {
      if (!dueDate || completed) return false;
      return new Date(dueDate) < new Date(new Date().toDateString());
    }

    function renderTodos() {
      const showCompleted = document.getElementById('showCompleted').checked;
      
      let filtered = todos
        .filter(todo => currentFilter === 'all' || todo.category === currentFilter)
        .filter(todo => showCompleted || !todo.completed)
        .sort((a, b) => {
          if (a.completed !== b.completed) return a.completed ? 1 : -1;
          const order = { high: 0, medium: 1, low: 2 };
          return order[a.priority] - order[b.priority];
        });

      // í†µê³„ ì—…ë°ì´íŠ¸
      const completed = todos.filter(t => t.completed).length;
      const overdue = todos.filter(t => !t.completed && isOverdue(t.dueDate, false)).length;
      document.getElementById('statRemaining').textContent = todos.length - completed;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statOverdue').textContent = overdue;

      const container = document.getElementById('todoList');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-2xl p-8 text-center text-slate-400">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤ âœ¨</div>';
        return;
      }

      container.innerHTML = filtered.map(todo => {
        const cat = TODO_CATEGORIES[todo.category] || TODO_CATEGORIES.other;
        const pri = PRIORITIES[todo.priority] || PRIORITIES.medium;
        const overdue = isOverdue(todo.dueDate, todo.completed);
        
        return `
          <div class="bg-white rounded-xl p-4 shadow-sm border transition-all ${todo.completed ? 'opacity-60 border-slate-100' : overdue ? 'border-red-200 bg-red-50/30' : 'border-slate-100 hover:shadow-md'}">
            <div class="flex items-start gap-3">
              <button onclick="toggleTodo('${todo.id}')" class="mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors flex-shrink-0 ${todo.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300 hover:border-green-500'}">
                ${todo.completed ? 'âœ“' : ''}
              </button>
              <div class="flex-1 min-w-0">
                <p class="text-slate-800 font-medium ${todo.completed ? 'line-through text-slate-400' : ''}">${todo.text}</p>
                <div class="flex flex-wrap items-center gap-2 mt-2">
                  <span class="px-2 py-1 rounded-md text-xs font-medium text-white ${cat.color}">${cat.name}</span>
                  <span class="px-2 py-1 rounded-md text-xs font-medium ${pri.color} ${pri.bg}">${pri.name}</span>
                  ${todo.dueDate ? `<span class="px-2 py-1 rounded-md text-xs ${overdue ? 'text-red-600 bg-red-100 font-medium' : 'text-slate-500 bg-slate-100'}">${new Date(todo.dueDate).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}${overdue ? ' (ê¸°í•œ ì´ˆê³¼)' : ''}</span>` : ''}
                </div>
              </div>
              <button onclick="deleteTodo('${todo.id}')" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg">ğŸ—‘</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ==================== ìº˜ë¦°ë” ====================
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      
      document.getElementById('calendarTitle').textContent = currentMonth.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startingDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const days = [];
      const prevMonth = new Date(year, month, 0);
      for (let i = startingDay - 1; i >= 0; i--) {
        days.push({ date: new Date(year, month - 1, prevMonth.getDate() - i), isCurrentMonth: false });
      }
      for (let i = 1; i <= daysInMonth; i++) {
        days.push({ date: new Date(year, month, i), isCurrentMonth: true });
      }
      const remaining = 42 - days.length;
      for (let i = 1; i <= remaining; i++) {
        days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
      }

      const today = new Date();
      document.getElementById('calendarGrid').innerHTML = days.map(day => {
        const dateStr = day.date.toISOString().split('T')[0];
        const dayTodos = todos.filter(t => t.dueDate === dateStr);
        const isToday = day.date.toDateString() === today.toDateString();
        const dow = day.date.getDay();

        return `
          <div class="min-h-24 p-1 md:p-2 border-b border-r border-slate-100 ${!day.isCurrentMonth ? 'bg-slate-50' : ''} ${isToday ? 'bg-blue-50' : ''}">
            <div class="text-sm font-medium mb-1 ${!day.isCurrentMonth ? 'text-slate-300' : isToday ? 'text-blue-600' : dow === 0 ? 'text-red-500' : dow === 6 ? 'text-blue-500' : 'text-slate-700'}">
              ${day.date.getDate()}${isToday ? ' <span class="text-xs">(ì˜¤ëŠ˜)</span>' : ''}
            </div>
            <div class="space-y-1">
              ${dayTodos.slice(0, 3).map(todo => {
                const cat = TODO_CATEGORIES[todo.category] || TODO_CATEGORIES.other;
                return `<div onclick="toggleTodo('${todo.id}')" class="text-xs p-1 rounded truncate cursor-pointer ${todo.completed ? 'line-through opacity-50 bg-slate-100' : cat.light}" title="${todo.text}">${todo.text}</div>`;
              }).join('')}
              ${dayTodos.length > 3 ? `<div class="text-xs text-slate-400 pl-1">+${dayTodos.length - 3}ê°œ</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function prevMonth() { currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1); renderCalendar(); }
    function goToToday() { currentMonth = new Date(); renderCalendar(); }

    // ==================== ì™¸ì„œ ê´€ë¦¬ ====================
    function setRightsView(view) {
      rightsView = view;
      document.getElementById('rightsTableBtn').className = `px-4 py-2 rounded-md text-sm font-medium ${view === 'table' ? 'bg-white shadow-sm' : 'text-slate-600'}`;
      document.getElementById('rightsKanbanBtn').className = `px-4 py-2 rounded-md text-sm font-medium ${view === 'kanban' ? 'bg-white shadow-sm' : 'text-slate-600'}`;
      document.getElementById('rightsTableView').classList.toggle('hidden', view !== 'table');
      document.getElementById('rightsKanbanView').classList.toggle('hidden', view !== 'kanban');
      renderBooks();
    }

    function getStageColor(stageId) {
      if (stageId <= 3) return '#f59e0b';
      if (stageId <= 6) return '#3b82f6';
      if (stageId <= 9) return '#8b5cf6';
      if (stageId <= 12) return '#10b981';
      return '#6b7280';
    }

    function renderBooks() {
      const search = document.getElementById('bookSearch').value.toLowerCase();
      const stageFilter = document.getElementById('stageFilter').value;
      const countryFilter = document.getElementById('countryFilter').value;

      const filtered = books.filter(book => {
        const matchesSearch = book.title.toLowerCase().includes(search) || book.author.toLowerCase().includes(search) || book.publisher.toLowerCase().includes(search);
        const matchesStage = stageFilter === 'all' || book.stage === parseInt(stageFilter);
        const matchesCountry = countryFilter === 'all' || book.country === countryFilter;
        return matchesSearch && matchesStage && matchesCountry;
      });

      if (rightsView === 'table') {
        renderBooksTable(filtered);
      } else {
        renderBooksKanban(filtered);
      }
    }

    function renderBooksTable(filtered) {
      const tbody = document.getElementById('booksTableBody');
      tbody.innerHTML = filtered.map(book => {
        const stage = STAGES.find(s => s.id === book.stage);
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50 cursor-pointer" onclick="showEditBookModal(${book.id})">
            <td class="p-4 font-medium text-slate-800">${book.title}</td>
            <td class="p-4 text-slate-600">${book.author}</td>
            <td class="p-4">${COUNTRY_FLAGS[book.country] || ''} ${book.country}</td>
            <td class="p-4 text-slate-600">${book.publisher}</td>
            <td class="p-4"><span class="stage-badge" style="background: ${getStageColor(book.stage)}20; color: ${getStageColor(book.stage)}">${stage?.icon} ${stage?.name}</span></td>
            <td class="p-4 text-slate-600">${book.advance ? `${book.advance.toLocaleString()} ${book.currency}` : '-'}</td>
            <td class="p-4 text-slate-600">${book.expiryDate || '-'}</td>
          </tr>
        `;
      }).join('');
    }

    function renderBooksKanban(filtered) {
      const groups = [
        { name: 'í˜‘ìƒ ì¤‘', stages: [1, 2, 3] },
        { name: 'ê³„ì•½ ì§„í–‰', stages: [4, 5, 6] },
        { name: 'ì œì‘ ì¤‘', stages: [7, 8, 9, 10] },
        { name: 'ì¶œê°„ ì™„ë£Œ', stages: [11, 12, 13, 14] }
      ];

      document.getElementById('kanbanBoard').innerHTML = groups.map(group => `
        <div class="flex-shrink-0 w-72 bg-slate-100 rounded-xl p-4">
          <h4 class="font-semibold text-slate-700 mb-4">${group.name} (${filtered.filter(b => group.stages.includes(b.stage)).length})</h4>
          <div class="space-y-3">
            ${filtered.filter(b => group.stages.includes(b.stage)).map(book => {
              const stage = STAGES.find(s => s.id === book.stage);
              return `
                <div class="kanban-card" onclick="showEditBookModal(${book.id})">
                  <div class="font-medium text-slate-800 mb-2">${book.title}</div>
                  <div class="text-sm text-slate-500 mb-2">${book.author}</div>
                  <div class="flex items-center justify-between">
                    <span class="text-xs">${COUNTRY_FLAGS[book.country]} ${book.country}</span>
                    <span class="stage-badge text-xs" style="background: ${getStageColor(book.stage)}20; color: ${getStageColor(book.stage)}">${stage?.icon} ${stage?.name}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');
    }

    function showEditBookModal(id) {
      selectedBook = books.find(b => b.id === id);
      if (!selectedBook) return;

      const stage = STAGES.find(s => s.id === selectedBook.stage);
      
      document.getElementById('editBookContent').innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ë„ì„œëª…</label>
              <input type="text" id="editTitle" value="${selectedBook.title}" class="input-field">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ì €ì</label>
              <input type="text" id="editAuthor" value="${selectedBook.author}" class="input-field">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">êµ­ê°€</label>
              <select id="editCountry" class="input-field">
                ${COUNTRIES.map(c => `<option value="${c}" ${selectedBook.country === c ? 'selected' : ''}>${COUNTRY_FLAGS[c]} ${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ì¶œíŒì‚¬</label>
              <input type="text" id="editPublisher" value="${selectedBook.publisher}" class="input-field">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600 mb-2">ì§„í–‰ ë‹¨ê³„</label>
            <div class="flex flex-wrap gap-2">
              ${STAGES.map(s => `
                <button onclick="updateBookStage(${s.id})" class="px-3 py-2 rounded-lg text-sm border-2 transition-colors ${selectedBook.stage === s.id ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 hover:border-slate-300'}">${s.icon} ${s.name}</button>
              `).join('')}
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ê³„ì•½ì¼</label>
              <input type="date" id="editContractDate" value="${selectedBook.contractDate || ''}" class="input-field">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ë§Œë£Œì¼</label>
              <input type="date" id="editExpiryDate" value="${selectedBook.expiryDate || ''}" class="input-field">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ì„ ì¸ì„¸</label>
              <input type="number" id="editAdvance" value="${selectedBook.advance || 0}" class="input-field">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">í†µí™”</label>
              <select id="editCurrency" class="input-field">
                <option value="USD" ${selectedBook.currency === 'USD' ? 'selected' : ''}>USD</option>
                <option value="EUR" ${selectedBook.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                <option value="JPY" ${selectedBook.currency === 'JPY' ? 'selected' : ''}>JPY</option>
                <option value="CNY" ${selectedBook.currency === 'CNY' ? 'selected' : ''}>CNY</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">ë©”ëª¨</label>
            <textarea id="editNotes" class="input-field" rows="3">${selectedBook.notes || ''}</textarea>
          </div>
          <div class="flex justify-between pt-4 border-t">
            <button onclick="deleteBook(${selectedBook.id})" class="btn btn-danger">ì‚­ì œ</button>
            <div class="flex gap-3">
              <button onclick="closeModal('editBookModal')" class="btn btn-secondary">ì·¨ì†Œ</button>
              <button onclick="saveBook()" class="btn btn-primary">ì €ì¥</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('editBookModal').classList.remove('hidden');
    }

    function updateBookStage(stageId) {
      selectedBook.stage = stageId;
      showEditBookModal(selectedBook.id);
    }

    function saveBook() {
      selectedBook.title = document.getElementById('editTitle').value;
      selectedBook.author = document.getElementById('editAuthor').value;
      selectedBook.country = document.getElementById('editCountry').value;
      selectedBook.publisher = document.getElementById('editPublisher').value;
      selectedBook.contractDate = document.getElementById('editContractDate').value;
      selectedBook.expiryDate = document.getElementById('editExpiryDate').value;
      selectedBook.advance = parseFloat(document.getElementById('editAdvance').value) || 0;
      selectedBook.currency = document.getElementById('editCurrency').value;
      selectedBook.notes = document.getElementById('editNotes').value;

      books = books.map(b => b.id === selectedBook.id ? selectedBook : b);
      saveBooks();
      renderBooks();
      updateAlertsBadge();
      closeModal('editBookModal');
      showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteBook(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        books = books.filter(b => b.id !== id);
        saveBooks();
        renderBooks();
        closeModal('editBookModal');
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function showAddBookModal() {
      document.getElementById('addBookContent').innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ë„ì„œëª… *</label>
              <input type="text" id="newBookTitle" class="input-field" placeholder="ë„ì„œëª…">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ì €ì *</label>
              <input type="text" id="newBookAuthor" class="input-field" placeholder="ì €ì">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">êµ­ê°€</label>
              <select id="newBookCountry" class="input-field">
                ${COUNTRIES.map(c => `<option value="${c}">${COUNTRY_FLAGS[c]} ${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">ì¶œíŒì‚¬</label>
              <input type="text" id="newBookPublisher" class="input-field" placeholder="í•´ì™¸ ì¶œíŒì‚¬">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600 mb-2">ì‹œì‘ ë‹¨ê³„</label>
            <div class="flex flex-wrap gap-2" id="newBookStageButtons"></div>
          </div>
          <div class="flex justify-end gap-3 pt-4">
            <button onclick="closeModal('addBookModal')" class="btn btn-secondary">ì·¨ì†Œ</button>
            <button onclick="addBook()" class="btn btn-primary">ë“±ë¡</button>
          </div>
        </div>
      `;

      // ë‹¨ê³„ ë²„íŠ¼ ìƒì„±
      let selectedStage = 1;
      const stageContainer = document.getElementById('newBookStageButtons');
      stageContainer.innerHTML = STAGES.slice(0, 6).map(s => `
        <button onclick="document.querySelectorAll('#newBookStageButtons button').forEach(b => b.className = 'px-3 py-2 rounded-lg text-sm border-2 border-slate-200'); this.className = 'px-3 py-2 rounded-lg text-sm border-2 border-blue-500 bg-blue-50 text-blue-700'; window.newBookStage = ${s.id}" class="px-3 py-2 rounded-lg text-sm border-2 ${s.id === 1 ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200'}">${s.icon} ${s.name}</button>
      `).join('');
      window.newBookStage = 1;

      document.getElementById('addBookModal').classList.remove('hidden');
    }

    function addBook() {
      const title = document.getElementById('newBookTitle').value.trim();
      const author = document.getElementById('newBookAuthor').value.trim();
      if (!title || !author) {
        showToast('ë„ì„œëª…ê³¼ ì €ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      const newBook = {
        id: Date.now(),
        title,
        author,
        country: document.getElementById('newBookCountry').value,
        publisher: document.getElementById('newBookPublisher').value,
        stage: window.newBookStage || 1,
        contractDate: '',
        expiryDate: '',
        advance: 0,
        currency: 'USD',
        notes: '',
        royalties: []
      };

      books.push(newBook);
      saveBooks();
      renderBooks();
      closeModal('addBookModal');
      showToast('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function saveBooks() {
      localStorage.setItem('rights-books', JSON.stringify(books));
    }

    // ==================== ì•Œë¦¼ ====================
    function getAlerts() {
      const today = new Date();
      return books.filter(book => {
        if (!book.expiryDate) return false;
        const expiry = new Date(book.expiryDate);
        const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        return daysUntil <= 90 && daysUntil > 0;
      }).map(book => {
        const expiry = new Date(book.expiryDate);
        const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        return { ...book, daysUntil };
      }).sort((a, b) => a.daysUntil - b.daysUntil);
    }

    function updateAlertsBadge() {
      const alerts = getAlerts();
      const badge = document.getElementById('alertsBadge');
      if (alerts.length > 0) {
        badge.textContent = alerts.length;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function showAlertsModal() {
      const alerts = getAlerts();
      
      document.getElementById('alertsContent').innerHTML = alerts.length === 0 ? `
        <div class="text-center py-8 text-slate-400">
          <div class="text-4xl mb-4">âœ¨</div>
          <div>90ì¼ ë‚´ ë§Œë£Œ ì˜ˆì •ì¸ ê³„ì•½ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <div class="space-y-3">
          ${alerts.map(book => `
            <div onclick="closeModal('alertsModal'); showEditBookModal(${book.id})" class="p-4 rounded-xl cursor-pointer transition-all hover:scale-102 ${book.daysUntil <= 30 ? 'bg-red-50 border border-red-200' : book.daysUntil <= 60 ? 'bg-yellow-50 border border-yellow-200' : 'bg-green-50 border border-green-200'}">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-semibold">${book.title}</div>
                  <div class="text-sm text-slate-500">${COUNTRY_FLAGS[book.country]} ${book.country} â€¢ ${book.publisher}</div>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-semibold text-white ${book.daysUntil <= 30 ? 'bg-red-500' : book.daysUntil <= 60 ? 'bg-yellow-500' : 'bg-green-500'}">D-${book.daysUntil}</span>
              </div>
              <div class="text-xs text-slate-500 mt-2">ë§Œë£Œì¼: ${book.expiryDate}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      document.getElementById('alertsModal').classList.remove('hidden');
    }

    // ==================== ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ====================
    function exportToExcel() {
      const data = books.map(book => ({
        'ë„ì„œëª…': book.title,
        'ì €ì': book.author,
        'êµ­ê°€': book.country,
        'ì¶œíŒì‚¬': book.publisher,
        'ì§„í–‰ ë‹¨ê³„': STAGES.find(s => s.id === book.stage)?.name || '',
        'ì„ ì¸ì„¸': book.advance,
        'í†µí™”': book.currency,
        'ê³„ì•½ì¼': book.contractDate,
        'ë§Œë£Œì¼': book.expiryDate,
        'ë©”ëª¨': book.notes
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ì™¸ì„œ ê´€ë¦¬');
      XLSX.writeFile(wb, `ì™¸ì„œê´€ë¦¬_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤');
    }

    // ==================== ëª¨ë‹¬ ====================
    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }
  </script>
</body>
</html>
